@using Lab2.Extensions
@using Lab2.ViewModels
@model Lab2.ViewModels.CalendarViewModel
@{
    ViewData["Title"] = "Booking Calendar";

    string? GetNavigationUrl(int daysOffset, string viewMode) =>
        Url.Action("Calendar", new
        {
            date = Model.SelectedDate.AddDays(daysOffset).ToString("yyyy-MM-dd"),
            viewMode = viewMode
        });
}

<div class="container-fluid">
    <div class="row mb-3">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2>Room Booking Calendar</h2>

                @* Simplified navigation *@
                @{
                    var isWeekView = Model.ViewMode == CalendarViewMode.Week;
                    var offset = isWeekView ? 7 : 1;
                    var currentLabel = isWeekView ? "Current Week" : "Today";
                    var prevLabel = isWeekView ? "Previous Week" : "Previous Day";
                    var nextLabel = isWeekView ? "Next Week" : "Next Day";
                    var modeParam = isWeekView ? "Week" : "Day";
                }

                <div class="btn-group" role="group">
                    <a href="@GetNavigationUrl(-offset, modeParam)" class="btn btn-outline-primary">
                        <i class="bi bi-chevron-left"></i> @prevLabel
                    </a>
                    <a asp-action="Calendar" asp-route-viewMode="@modeParam" class="btn btn-outline-primary">
                        @currentLabel
                    </a>
                    <a href="@GetNavigationUrl(offset, modeParam)" class="btn btn-outline-primary">
                        @nextLabel <i class="bi bi-chevron-right"></i>
                    </a>
                </div>

                <div class="btn-group" role="group">
                    <a asp-action="Calendar" asp-route-date="@Model.SelectedDate.ToString("yyyy-MM-dd")" asp-route-viewMode="Day"
                       class="btn btn-outline-secondary @(Model.ViewMode == CalendarViewMode.Day ? "active" : "")">
                        Day
                    </a>
                    <a asp-action="Calendar" asp-route-date="@Model.SelectedDate.ToString("yyyy-MM-dd")" asp-route-viewMode="Week"
                       class="btn btn-outline-secondary @(Model.ViewMode == CalendarViewMode.Week ? "active" : "")">
                        Week
                    </a>
                </div>
            </div>
        </div>
    </div>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <div class="card">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
                @if (Model.ViewMode == CalendarViewMode.Week)
                {
                    <span>Week: @Model.WeekStart.ToString("dd.MM.yyyy") - @Model.WeekEnd.ToString("dd.MM.yyyy")</span>
                }
                else
                {
                    <span>@Model.SelectedDate.ToString("dddd, dd MMMM yyyy")</span>
                }
            </h5>
        </div>
        <div class="card-body p-0">
            <div id="calendar-loading" class="text-center p-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Fetching bookings...</p>
            </div>
            <div id="calendar-content" class="table-responsive" style="display: none;">
                <table class="table table-bordered table-hover calendar-table mb-0">
                    <thead class="table-light sticky-top">
                        <tr>
                            <th class="time-column">Time</th>
                            @if (Model.ViewMode == CalendarViewMode.Week)
                            {
                                @for (int i = 0; i < 7; i++)
                                {
                                    var day = Model.WeekStart.AddDays(i);
                                    var isToday = day.Date == DateTime.Today;
                                    <th colspan="@Model.Rooms.Count()" class="text-center @(isToday ? "bg-info-subtle" : "")">
                                        <div class="fw-bold">@day.ToString("dddd")</div>
                                        <div class="text-muted small">@day.ToString("dd.MM")</div>
                                    </th>
                                }
                            }
                            else
                            {
                                <th colspan="@Model.Rooms.Count()" class="text-center bg-info-subtle">
                                    <div class="fw-bold">@Model.SelectedDate.ToString("dddd")</div>
                                    <div class="text-muted small">@Model.SelectedDate.ToString("dd MMMM yyyy")</div>
                                </th>
                            }
                        </tr>
                        <tr>
                            <th class="time-column"></th>
                            @if (Model.ViewMode == CalendarViewMode.Week)
                            {
                                @for (int i = 0; i < 7; i++)
                                {
                                    var day = Model.WeekStart.AddDays(i);
                                    @foreach (var room in Model.Rooms)
                                    {
                                        <th class="room-column text-center small">
                                            <div class="fw-semibold">@room.Name</div>
                                            <div class="text-muted">@room.Capacity <i class="bi bi-people-fill"></i></div>
                                        </th>
                                    }
                                }
                            }
                            else
                            {
                                @foreach (var room in Model.Rooms)
                                {
                                    <th class="room-column text-center">
                                        <div class="fw-semibold">@room.Name</div>
                                        <div class="text-muted">Capacity: @room.Capacity people</div>
                                    </th>
                                }
                            }
                        </tr>
                    </thead>
                    <tbody id="calendar-body">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    @if (!Model.Rooms.Any() && User.IsAdmin())
    {
        <div class="alert alert-warning mt-3">
            <i class="bi bi-exclamation-triangle"></i> No rooms available.
            <a asp-controller="Room" asp-action="Manage">Add room</a>
        </div>
    }
</div>

<div class="modal fade" id="bookingModal" tabindex="-1" aria-labelledby="bookingModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bookingModalLabel">New Booking</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label fw-bold">Room:</label>
                    <p id="modal-room-name" class="form-control-plaintext"></p>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Date and Time:</label>
                    <p id="modal-datetime" class="form-control-plaintext"></p>
                </div>
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> The booking will be assigned to your account: <strong>@User.Identity?.Name</strong>
                </div>
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Important:</strong> Booking must last minimum 15 minutes and maximum 3 hours.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmBookingBtn">
                    <i class="bi bi-check-circle"></i> Confirm Booking
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const calendarData = {
            viewMode: '@Model.ViewMode',
            selectedDate: '@Model.SelectedDate.ToString("yyyy-MM-dd")',
            weekStart: '@Model.WeekStart.ToString("yyyy-MM-dd")',
            weekEnd: '@Model.WeekEnd.ToString("yyyy-MM-dd")',
            workingHours: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.WorkingHours)),
            rooms: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Rooms)),
            currentUser: '@User.Identity?.Name',
            isAuthenticated: @Html.Raw(User.Identity?.IsAuthenticated == true ? "true" : "false"),
            isAdmin: @Html.Raw(User.IsInRole("Admin") ? "true" : "false")
        };

        $(document).ready(function() {
            let selectedSlot = null;
            let bookingsCache = {};

            async function loadBookingsForDay(date) {
                if (bookingsCache[date]) {
                    return bookingsCache[date];
                }

                try {
                    const response = await $.ajax({
                        url: '/api/booking/getforday',
                        type: 'GET',
                        data: { date: date }
                    });

                    if (response.success) {
                        bookingsCache[date] = response.bookings;
                        return response.bookings;
                    }
                } catch (error) {
                    console.error('Error loading bookings:', error);
                }
                return [];
            }

            async function renderCalendar() {
                $('#calendar-loading').show();
                $('#calendar-content').hide();

                const tbody = $('#calendar-body');
                tbody.empty();

                const dates = calendarData.viewMode === 'Week'
                    ? getDatesInWeek()
                    : [calendarData.selectedDate];

                const allBookingsMap = {};
                const bookingsArrays = await Promise.all(dates.map(date => loadBookingsForDay(date)));
                dates.forEach((date, idx) => {
                    allBookingsMap[date] = bookingsArrays[idx];
                });

                calendarData.workingHours.forEach(hour => {
                    const row = $('<tr>');
                    row.append(`<td class="time-column fw-bold text-center align-middle">${hour}:00 - ${hour + 1}:00</td>`);

                    dates.forEach(dateStr => {
                        calendarData.rooms.forEach(room => {
                            const slotStart = `${dateStr} ${hour.toString().padStart(2, '0')}:00`;
                            const slotEnd = `${dateStr} ${(hour + 1).toString().padStart(2, '0')}:00`;

                            const booking = findBookingForSlot(allBookingsMap[dateStr], room.Id, slotStart, slotEnd);
                            const cell = createCell(booking, room, slotStart, slotEnd);
                            row.append(cell);
                        });
                    });

                    tbody.append(row);
                });

                $('#calendar-loading').hide();
                $('#calendar-content').show();
                attachEventHandlers();
            }

            function getDatesInWeek() {
                const dates = [];
                for (let i = 0; i < 7; i++) {
                    const date = new Date(calendarData.weekStart);
                    date.setDate(date.getDate() + i);
                    dates.push(date.toISOString().split('T')[0]);
                }
                return dates;
            }

            function findBookingForSlot(bookings, roomId, slotStart, slotEnd) {
                return bookings.find(b => {
                    const bStart = new Date(b.startTime);
                    const bEnd = new Date(b.endTime);
                    const sStart = new Date(slotStart.replace(' ', 'T'));
                    const sEnd = new Date(slotEnd.replace(' ', 'T'));

                    return b.roomId === roomId && bStart < sEnd && bEnd > sStart;
                });
            }

            function createCell(booking, room, slotStart, slotEnd) {
                const cell = $('<td>');

                if (booking) {
                    const isOwner = calendarData.currentUser === booking.userName;
                    const canDelete = isOwner || calendarData.isAdmin === true;

                    cell.addClass('booking-slot booked position-relative')
                        .attr('data-booking-id', booking.bookingId)
                        .attr('data-room-name', room.name)
                        .attr('data-user-name', booking.userName)
                        .attr('data-start', booking.startTime)
                        .attr('data-end', booking.endTime);

                    const bookingInfo = $('<div class="booking-info">');
                    bookingInfo.append(`<small class="d-block text-truncate"><i class="bi bi-person-circle"></i> ${booking.userName}</small>`);

                    const start = new Date(booking.startTime);
                    const end = new Date(booking.endTime);
                    bookingInfo.append(`<small class="text-muted">${start.toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'})} - ${end.toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'})}</small>`);

                    cell.append(bookingInfo);

                    if (canDelete) {
                        const deleteBtn = $('<button>')
                            .addClass('btn btn-sm btn-danger delete-booking-btn position-absolute top-0 end-0 m-1')
                            .attr('data-booking-id', booking.bookingId)
                            .attr('title', 'Delete booking')
                            .html('<i class="bi bi-x-lg"></i>');
                        cell.append(deleteBtn);
                    }
                } else {
                    const isPast = new Date(slotStart.replace(' ', 'T')) < new Date();
                    cell.addClass(`booking-slot ${isPast ? 'past-slot' : 'available'}`)
                        .addClass('text-center')
                        .attr('data-room-id', room.Id)
                        .attr('data-room-name', room.Name)
                        .attr('data-start', slotStart)
                        .attr('data-end', slotEnd);

                    if (!isPast) {
                        cell.attr('role', 'button');
                        cell.append('<span class="text-muted small">Available</span>');
                    }
                }

                return cell;
            }

            function attachEventHandlers() {
                $('.booking-slot.available').off('click').on('click', function() {
                    if (calendarData.isAuthenticated === true) {
                        selectedSlot = $(this);
                        const roomName = selectedSlot.data('room-name');
                        const startTime = selectedSlot.data('start');
                        const endTime = selectedSlot.data('end');

                        $('#modal-room-name').text(roomName);
                        $('#modal-datetime').text(
                            new Date(startTime.replace(' ', 'T')).toLocaleString('en-US') + ' - ' +
                            new Date(endTime.replace(' ', 'T')).toLocaleTimeString('en-US')
                        );

                        $('#bookingModal').modal('show');
                    } else {
                        alert('You must be logged in to make a booking.');
                        window.location.href = '@Url.Action("Login", "Account")';
                    }
                });

                $('.booking-slot.booked').off('click').on('click', function() {
                    const userName = $(this).data('user-name');
                    const roomName = $(this).data('room-name');
                    const start = new Date($(this).data('start')).toLocaleString('en-US');
                    const end = new Date($(this).data('end')).toLocaleTimeString('en-US');

                    alert(`Room: ${roomName}\nBooked by: ${userName}\nTime: ${start} - ${end}`);
                });

                $('.delete-booking-btn').off('click').on('click', function(e) {
                    e.stopPropagation();

                    if (!confirm('Are you sure you want to delete this booking?')) {
                        return;
                    }

                    const bookingId = $(this).data('booking-id');

                    $.ajax({
                        url: '@Url.Action("DeleteBooking", "Booking")/' + bookingId,
                        type: 'DELETE',
                        success: function(response) {
                            bookingsCache = {};
                            renderCalendar();
                        },
                        error: function(xhr) {
                            alert('Error: ' + (xhr.responseJSON?.error || 'Failed to delete booking'));
                        }
                    });
                });
            }

            $('#confirmBookingBtn').on('click', function() {
                if (!selectedSlot) return;

                const bookingData = {
                    RoomId: parseInt(selectedSlot.data('room-id')),
                    StartTime: selectedSlot.data('start').replace(' ', 'T') + ':00',
                    EndTime: selectedSlot.data('end').replace(' ', 'T') + ':00'
                };

                $.ajax({
                    url: '/api/booking/create',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(bookingData),
                    success: function(response) {
                        $('#bookingModal').modal('hide');

                        if (response.success && response.booking) {
                            alert(`Booking created successfully!\n\nRoom: ${response.booking.roomName}\nDuration: ${response.booking.duration} minutes`);
                        }

                        bookingsCache = {};
                        renderCalendar();
                    },
                    error: function(xhr) {
                        if (xhr.responseJSON) {
                            if (xhr.responseJSON.errors && Array.isArray(xhr.responseJSON.errors)) {
                                alert('Validation errors:\n\n• ' + xhr.responseJSON.errors.join('\n• '));
                            } else if (xhr.responseJSON.error) {
                                alert('Error: ' + xhr.responseJSON.error);
                            } else {
                                alert('Failed to create booking');
                            }
                        } else {
                            alert('Server connection error');
                        }
                    }
                });
            });

            renderCalendar();
        });
    </script>
}
